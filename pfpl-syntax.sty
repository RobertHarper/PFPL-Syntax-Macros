\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pfpl-syntax}[2022/01/15 1.0.0 PFPL Syntax Macros]
\RequirePackage{amsmath,amssymb,amsthm,mathtools,stmaryrd,bigplustimes}

\ProvideDocumentCommand{\kw}{m}{\texttt{#1}}
\ProvideDocumentCommand{\singmap}{m m}{#1\hookrightarrow #2}
\ProvideDocumentCommand{\finmap}{m m m}{\singmap{#2}{#3_#2}\mid #2\in #1}

\newboolean{opnidx}\setboolean{opnidx}{false}  % typeset operator indices or not

% starred for math name, non-starred for verbatim name, optional index
\NewDocumentCommand{\Opn}{s m o}{\mathop{\IfBooleanTF{#1}{#2}{\kw{#2}}\IfValueT{#3}{\ifthenelse{\boolean{opnidx}}{_{#3}}{}}}}

% applied form of \Abt allows for optional argument and omission of main argument.  
% starred form of \Abt suppresses optional argument
\NewDocumentCommand{\Var}{m d<> d()}{\mathop{#1}\IfValueT{#2}{\,\langle #2\rangle\,}\IfValueT{#3}{(#3)}}
\NewDocumentCommand{\Abs}{d<> d() m}{\IfValueT{#1}{#1\mathbin{.}}\IfValueT{#2}{#2\mathbin{.}} #3}
\NewDocumentCommand{\Abt}{s m d<> o m}{\mathop{#2}\IfValueT{#3}{\langle #3\rangle}\IfBooleanF{#1}{\IfValueT{#4}{[#4]}}\ifthenelse{\isempty{#5}}{}{(#5)}}
% choose starred form abt according to argument
\NewDocumentCommand{\Abbrt}{m}{\IfBooleanTF{#1}{\Abt*}{\Abt}}

% yes/no answer type
\NewDocumentCommand{\ansty}{s}{\Abt{\Opn{ans}}{}}
\NewDocumentCommand{\yesex}{s}{\Abt{\Opn{yes}}{}}
\NewDocumentCommand{\noex}{s}{\Abt{\Opn{no}}{}}

% product types in all their glory
% nullary
\NewDocumentCommand{\unitty}{s}{\Abt{\IfBooleanTF{#1}{\Opn{1}}{\Opn{unit}}}{}}
\NewDocumentCommand{\unitex}{s}{\IfBooleanTF{#1}{\langle\rangle}{\Abt{\Opn{null}}{}}}
% binary
\NewDocumentCommand{\prodabt}{m m}{\Abt{\Opn{prod}}{#1;#2}}
\NewDocumentCommand{\prodcst}{m m}{#1\times #2}
\NewDocumentCommand{\prodty}{s m m}{\IfBooleanTF{#1}{\prodcst{#2}{#3}}{\prodabt{#2}{#3}}}
\NewDocumentCommand{\pairabt}{m m m m}{\Abt{\Opn{pair}}[#1;#2]{#3; #4}}
\NewDocumentCommand{\paircst}{m m}{\langle #1, #2\rangle}
\NewDocumentCommand{\pairex}{s O{\tau_1} O{\tau_2} m m}{\IfBooleanTF{#1}{\paircst{#4}{#5}}{\pairabt{#2}{#3}{#4}{#5}}}
\NewDocumentCommand{\projabt}{m m m m}{\Abt{\Opn{proj}}<#1>[#2;#3]{#4}}
\NewDocumentCommand{\projcst}{m m}{#2\cdot #1}
\NewDocumentCommand{\projex}{s d<> O{\tau_1} O{\tau_2} m}{\IfBooleanTF{#1}{\projcst{#2}{#5}}{\projabt{#2}{#3}{#4}{#5}}}
% n-ary
\NewDocumentCommand{\vprodabt}{m m m}{\Abt{\Opn{prod}[#1]}{\finmap{#1}{#2}{#3}}}
\NewDocumentCommand{\vprodcst}{m m m}{\bigtimes_{#2\in #1}(\singmap{#2}{{#3}_{#2}})}
\NewDocumentCommand{\vprodty}{s D<>{I} D<>{i} m}{\IfBooleanTF{#1}{\vprodcst{#2}{#3}{#4}}{\vprodabt{#2}{#3}{#4}}}
\NewDocumentCommand{\vtupleabt}{m m m m}{\Abt{\Opn{tuple}[#1]}[#3_#1]{\finmap{#1}{#2}{#4}}}
\NewDocumentCommand{\vtuplecst}{m m m}{\langle \singmap{#2}{#3_{#2}}\mid #2\in #1\rangle}
\NewDocumentCommand{\vtupleex}{s D<>{I} D<>{i} O{\tau} m}{\IfBooleanTF{#1}{\vtuplecst{#2}{#3}{#5}}{\vtupleabt{#2}{#3}{#4}{#5}}}
\NewDocumentCommand{\vprojabt}{m m m m}{\Abt{\Opn{proj}[#1]}<#2>[#3_{#1}]{#4}}
\NewDocumentCommand{\vprojcst}{m m}{#2\cdot #1}
\NewDocumentCommand{\vprojex}{s D<>{I} D<>{i} O{\tau} m}{\IfBooleanTF{#1}{\vprojcst{#3}{#5}}
{\vprojabt{#2}{#3}{#4}{#5}}}

% sum types in all their glory
% nullary
\NewDocumentCommand{\voidty}{s}{\Abt{\IfBooleanTF{#1}{\Opn{0}}{\Opn{void}}}{}}
\NewDocumentCommand{\absurdex}{s O{\rho} m}{\Abbrt{#1}{\Opn{absurd}}[#2]{#3}}
% binary
\NewDocumentCommand{\sumabt}{m m}{\Abt{\Opn{sum}}{#1; #2}}
\NewDocumentCommand{\sumcst}{m m}{#1+#2}
\NewDocumentCommand{\sumty}{s m m}{\IfBooleanTF{#1}{\sumcst{#2}{#3}}{\sumabt{#2}{#3}}}
\NewDocumentCommand{\injabt}{d<> m m m}{\Abt{\Opn{inj}}<#1>[#2;#3]{#4}}
\NewDocumentCommand{\injcst}{d<> m}{#1\cdot #2}
\NewDocumentCommand{\injex}{s d<> O{\tau_1} O{\tau_2} m}{\IfBooleanTF{#1}{\injcst<#2>{#5}}{\injabt<#2>{#3}{#4}{#5}}}
\NewDocumentCommand{\caseabt}{m m m m m}{\Abt{\Opn{case}}[#1; #2_1; #2_2]{#3; \Abs(#4){#5_1}; \Abs(#4){#5_2}}}
\NewDocumentCommand{\casecst}{m m m}{\Opn{case} #1\,\{\singmap{\kw{1}}{\Abs(#2){#3_1}} \mid \singmap{\kw{2}}{\Abs(#2){#3_2}}\}}
\NewDocumentCommand{\caseex}{s O{\rho} O{\tau} m m m}{\IfBooleanTF{#1}{\casecst{#4}{#5}{#6}}{\caseabt{#2}{#3}{#4}{#5}{#6}}}
% n-ary
\NewDocumentCommand{\vsumabt}{m m m}{\Abt{\Opn{sum}[#1]}{\finmap{#1}{#2}{#3}}}
\NewDocumentCommand{\vsumcst}{m m m}{\bigplus_{#2\in #1}(\singmap{#2}{{#3}_{#2}})}
\NewDocumentCommand{\vsumty}{s D<>{I} D<>{i} m}{\IfBooleanTF{#1}{\vsumcst{#2}{#3}{#4}}{\vsumabt{#2}{#3}{#4}}}
\NewDocumentCommand{\vinjabt}{m m m m}{\Abt{\Opn{inj}[#1]}<#2>[#3_{#1}]{#4}}
\NewDocumentCommand{\vinjcst}{m m}{#1\cdot #2}
\NewDocumentCommand{\vinjex}{s D<>{I} D<>{i} O{\tau} m}{\IfBooleanTF{#1}{\vinjcst{#3}{#5}}{\vinjabt{#2}{#3}{#4}{#5}}}
\NewDocumentCommand{\vcaseabt}{m m m m m m m}{\Abt{\Opn{case}[#1]}[#3;#4_#1]{#5;\finmap{#1}{#2}{\Abs(#6){#7}}}}
\NewDocumentCommand{\vcasecst}{m m m m m}{\Opn{case} #3\,\{\finmap{#1}{#2}{\Abs(#4){#5}}\}}
\NewDocumentCommand{\vcaseex}{s D<>{I} D<>{i} O{\rho} O{\tau} m m m}{\IfBooleanTF{#1}{\vcasecst{#2}{#3}{#6}{#7}{#8}}{\vcaseabt{#2}{#3}{#4}{#5}{#6}{#7}{#8}}}

% booleans, sum of one and one.
\NewDocumentCommand{\boolty}{s}{\Abt{\IfBooleanTF{#1}{\Opn{2}}{\Opn{bool}}}{}}
\NewDocumentCommand{\trueex}{s}{\Abt{\Opn{true}}{}}
\NewDocumentCommand{\falseex}{s}{\Abt{\Opn{false}}{}}
\NewDocumentCommand{\ifex}{s O{\rho} m m m}{\Abbrt{#1}{\Opn{if}}[#2]{#3; #4; #5}}

% total function type
\NewDocumentCommand{\arrabt}{m m}{\Abt{\Opn{arr}}{#1; #2}}
\NewDocumentCommand{\arrcst}{m m}{#1\to #2}
\NewDocumentCommand{\arrty}{s m m}{\IfBooleanTF{#1}{\arrcst{#2}{#3}}{\arrabt{#2}{#3}}}
\NewDocumentCommand{\lamex}{s O{\tau_1} m O{\tau_2} m}{\Abbrt{#1}{\Opn*{\lambda}}[#2;#4]{\Abs(#3){#5}}}
\NewDocumentCommand{\appex}{s O{\tau_1} O{\tau_2} m m}{\Abbrt{#1}{\Opn{ap}}[#2;#3]{\Abs{#4}{#5}}}

% inductive type; intro is foldex below
\NewDocumentCommand{\indty}{s m m}{\Abt{\Opn{ind}}{\Abs(#2){#3}}}
\NewDocumentCommand{\recex}{s O{t} O{\tau} O{\rho} m m m}{\Abbrt{#1}{\Opn{rec}}[\Abs(#2){#3}; #4]{#5;\Abs(#6){#7}}}
% coinductive type; elim is unfoldex below
\NewDocumentCommand{\coity}{s m m}{\Abt{\Opn{coi}}{\Abs(#2){#3}}}
\NewDocumentCommand{\genex}{s O{t} O{\tau} O{\sigma} m m m}{\Abbrt{#1}{\Opn{gen}}[\Abs(#2){#3};#4]{#5;\Abs(#6){#7}}}

% universal and existential types
\NewDocumentCommand{\Allty}{s m m}{\Abt{\Opn*{\forall}}{\Abs(#2){#3}}}
\NewDocumentCommand{\Lamex}{s m O{\tau} m}{\Abbrt{#1}{\Opn*{\Lambda}}[\Abs(#2){#3}]{\Abs(#2){#4}}}
\NewDocumentCommand{\Appex}{s O{t} O{\tau} m m}{\Abbrt{#1}{\Opn{Ap}}[\Abs(#2){#3}]{#4;#5}}

\NewDocumentCommand{\Somety}{s m m}{\Abt{\Opn*{\exists}}{\Abs(#2){#3}}}
\NewDocumentCommand{\Packabt}{m m m m}{\Abt{\Opn{Pack}}[\Abs(#1){#2}]{#3; #4}}
\NewDocumentCommand{\Packcst}{m m m m}{\Packabt{#1}{#2}{#3}{#4}}
\NewDocumentCommand{\Packex}{s O{t} O{\tau} m m}{\Abbrt{#1}{\Opn{Pack}}[\Abs(#2){#3}]{#4; #5}}
\NewDocumentCommand{\Openabt}{m m m m m m}{\Abt{\Opn{Open}}[\Abs(#1){#2};#4]{#3;\Abs(#1,#5){#6}}}
\NewDocumentCommand{\Openex}{s O{t} O{\tau} m O{\rho} m m}{\Abbrt{#1}{\Opn{Open}}[\Abs(#2){#3};#5]{#4;\Abs(#2,#6){#7}}}

% partial function type with recursive lambda
\NewDocumentCommand{\parrabt}{m m}{\Abt{\Opn{parr}}{#1; #2}}
\NewDocumentCommand{\parrcst}{m m}{#1\mathbin{\rightharpoonup} #2}
\NewDocumentCommand{\parrty}{s m m}{\IfBooleanTF{#1}{\parrcst{#2}{#3}}{\parrabt{#2}{#3}}}
\NewDocumentCommand{\funex}{s O{\tau_1} O{\tau_2} m m m}{\Abbrt{#1}{\Opn{fun}}[#2;#3]{\Abs(#4,#5){#6}}}
\NewDocumentCommand{\pappex}{s O{\tau_1} O{\tau_2} m m}{\Abbrt{#1}{\Opn{app}}[#2;#3]{\Abs{#4}{#5}}}
\NewDocumentCommand{\fixex}{s O{\tau} m m}{\Abbrt{#1}{\Opn{fix}}[#2]{\Abs(#3){#4}}}

% recursive type
\NewDocumentCommand{\recty}{s m m}{\Abt{\Opn{rec}}{\Abs(#2){#3}}}
\NewDocumentCommand{\foldex}{s O{t} O{\tau} m}{\Abbrt{#1}{\Opn{fold}}[\Abs(#2){#3}]{#4}}
\NewDocumentCommand{\unfoldex}{s O{t} O{\tau} m}{\Abbrt{#1}{\Opn{unfold}}[\Abs(#2){#3}]{#4}}

% untyped
\NewDocumentCommand{\ulamex}{s m m}{\lamex*{#2}{#3}}
\NewDocumentCommand{\uapex}{s m m}{\appex*{#2}{#3}}

% commands
\NewDocumentCommand{\cmdty}{s m}{\Abt{\Opn{cmd}}{#2}}
\NewDocumentCommand{\cmdex}{s O{\tau} m}{\Abbrt{#1}{\Opn{cmd}}[#2]{#3}}

\NewDocumentCommand{\retcmd}{s O{\tau} m}{\Abbrt{#1}{\Opn{ret}}[#2]{#3}}

\NewDocumentCommand{\dclabt}{m m m m}{\Abt{\Opn{dcl}}[#1; #2]{#3; #4}}
\NewDocumentCommand{\dclcst}{m m m}{\Opn{dcl}#2\mathbin{\kw{:=}}#1\mathbin{\kw{in}}#3}
\NewDocumentCommand{\dclcmd}{s O{\tau} m O{\rho} m m}{\IfBooleanTF{#1}{\dclcst{#3}{#5}{#6}}{\dclabt{#2}{#4}{#3}{\Abs<#5>{#6}}}}

\NewDocumentCommand{\bndabt}{m m m m m}{\Abt{\Opn{bnd}}[#1; #2]{#3; \Abs(#4){#5}}}
\NewDocumentCommand{\bndcst}{m m m}{\kw{bnd}\,#2\mathbin{\leftarrow}#1\mathbin{\kw{;}}#3}
\NewDocumentCommand{\bndcmd}{s O{\tau} m O{\rho} m m}{\IfBooleanTF{#1}{\bndcst{#3}{#5}{#6}}{\bndabt{#2}{#4}{#3}{#5}{#6}}}

% reference types
\NewDocumentCommand{\refabt}{m}{\Abt{\Opn{ref}}<#1>{}}
\NewDocumentCommand{\refcst}{m}{\texttt{\&}\,#1}
\NewDocumentCommand{\refex}{s m}{\IfBooleanTF{#1}{\refcst{#2}}{\refabt{#2}}}

\NewDocumentCommand{\getabt}{m}{\Abt{\Opn{get}}<#1>{}}
\NewDocumentCommand{\getcst}{m}{\Opn{!}{#1}}
\NewDocumentCommand{\getcmd}{s m}{\IfBooleanTF{#1}{\getcst{#2}}{\getabt{#2}}}

\NewDocumentCommand{\getrefabt}{m m}{\Abt{\Opn{getref}}[#1]{#2}}
\NewDocumentCommand{\getrefcst}{m}{\kw{*}#1}
\NewDocumentCommand{\getrefcmd}{s O{\tau} m}{\IfBooleanTF{#1}{\getrefcst{#3}}{\getrefabt{#2}{#3}}}

\NewDocumentCommand{\setabt}{m m}{\Abt{\Opn{set}}<#1>{#2}}
\NewDocumentCommand{\setcst}{m m}{#1\mathbin{\kw{:=}}#2}
\NewDocumentCommand{\setcmd}{s m m}{\IfBooleanTF{#1}{\setcst{#2}{#3}}{\setabt{#2}{#3}}}

\NewDocumentCommand{\setrefabt}{m m m}{\Abt{\Opn{setref}}[#1]{#2; #3}}
\NewDocumentCommand{\setrefcst}{m m}{#1\mathbin{\kw{*{=}}} #2}
\NewDocumentCommand{\setrefcmd}{s O{\tau} m m}{\IfBooleanTF{#1}{\setrefcst{#3}{#4}}{\setrefabt{#2}{#3}{#4}}}

% dependent types
\NewDocumentCommand{\univsg}{s}{\Abt{\Opn{type}}{}}
\NewDocumentCommand{\valmod}{s m}{\Abt{\Opn{val}}{#2}}

\NewDocumentCommand{\piabt}{m m m}{\Abt{\Opn*{\prod}}{#1;\Abs(#2){#3}}}
\NewDocumentCommand{\picst}{m m m}{#2{\mathbin{:}}#1\to #3}
\NewDocumentCommand{\pisg}{s m m m}{\IfBooleanTF{#1}{\picst{#2}{#3}{#4}}{\piabt{#2}{#3}{#4}}}

\NewDocumentCommand{\sigabt}{m m m}{\Abt{\Opn*{\sum}}{#1;\Abs(#2){#3}}}
\NewDocumentCommand{\sigcst}{m m m}{#2{\mathbin{:}}#1\times #3}
\NewDocumentCommand{\sigsg}{s m m m}{\IfBooleanTF{#1}{\sigcst{#2}{#3}{#4}}{\sigabt{#2}{#3}{#4}}}

\NewDocumentCommand{\extabt}{m m}{\Abt{\Opn{Ext}}{#1; #2}}
\NewDocumentCommand{\extcst}{m m}{\{#1\mid \textsf{st}\hookrightarrow #2\}}
\NewDocumentCommand{\extsg}{s m m}{\IfBooleanTF{#1}{\extcst{#2}{#3}}{\extabt{#2}{#3}}}

\NewDocumentCommand{\compabt}{m}{\Abt{\Opn{Comp}}{#1}}
\NewDocumentCommand{\compcst}{m}{\mathop{\bigcirc} #1}
\NewDocumentCommand{\compsg}{s m}{\IfBooleanTF{#1}{\compcst{#2}}{\compabt{#2}}}

